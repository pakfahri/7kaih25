<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Harian Siswa - Digital Tracking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [KODE CSS SAMA PERSIS DENGAN SEBELUMNYA] */
        /* Tetap pertahankan semua style yang ada */
        
        /* Hanya tambahan kecil untuk nilai */
        .nilai-detail {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- [SELURUH KODE HTML TETAP SAMA] -->
    <!-- Hanya tambahkan script untuk perhitungan nilai -->

    <script type="module">
        // [SEMUA KODE JAVASCRIPT YANG SUDAH ADA]
        // Hanya tambahkan fungsi perhitungan nilai di bagian yang sesuai

        // ✅ FUNCTION HITUNG NILAI SISWA (DITAMBAHKAN KEMBALI)
        function hitungNilaiSiswa(journals) {
            if (journals.length === 0) return { 
                rataRata: 0, 
                totalPoin: 0, 
                totalHari: 0, 
                detail: {},
                persentase: 0
            };
            
            let totalPoin = 0;
            let totalHari = 0;
            const hariUnik = new Set();
            const detailHarian = {};
            
            journals.forEach(journal => {
                // Hitung poin per jurnal
                let poinHarian = 0;
                
                // ✅ 1 ceklis = 1 poin
                const jumlahCeklis = Object.values(journal.activities).filter(val => val).length;
                poinHarian += jumlahCeklis;
                
                // ✅ Mengisi doa = 1 poin
                if (journal.doa && journal.doa.trim() !== '') {
                    poinHarian += 1;
                }
                
                // Maksimal poin per hari = jumlah activities + 1 (doa)
                const maksimalPoin = Object.keys(journal.activities).length + 1;
                
                // Simpan detail harian
                const tanggal = journal.date;
                if (!detailHarian[tanggal]) {
                    detailHarian[tanggal] = {
                        poin: 0,
                        maksimal: maksimalPoin,
                        ceklis: 0,
                        doa: 0,
                        persentase: 0
                    };
                    hariUnik.add(tanggal);
                }
                
                detailHarian[tanggal].poin += poinHarian;
                detailHarian[tanggal].ceklis += jumlahCeklis;
                if (journal.doa && journal.doa.trim() !== '') {
                    detailHarian[tanggal].doa += 1;
                }
                detailHarian[tanggal].persentase = Math.round((poinHarian / maksimalPoin) * 100);
                
                totalPoin += poinHarian;
            });
            
            totalHari = hariUnik.size;
            const rataRata = totalHari > 0 ? (totalPoin / totalHari).toFixed(1) : 0;
            const totalMaksimalPoin = totalHari * (Object.keys(activities).length + 1);
            const persentase = totalMaksimalPoin > 0 ? Math.round((totalPoin / totalMaksimalPoin) * 100) : 0;
            
            return {
                rataRata: parseFloat(rataRata),
                totalPoin: totalPoin,
                totalHari: totalHari,
                persentase: persentase,
                detail: detailHarian
            };
        }

        // ✅ FUNCTION TAMPILKAN NILAI (DITAMBAHKAN KEMBALI)
        function tampilkanNilaiSiswa(journals, studentName) {
            const nilaiStatCard = document.getElementById('nilaiStatCard');
            const rataRataNilai = document.getElementById('rataRataNilai');
            const detailNilai = document.getElementById('detailNilai');
            
            if (selectedStudent !== 'all' && journals.length > 0) {
                const nilai = hitungNilaiSiswa(journals);
                
                // Tampilkan stat card nilai
                nilaiStatCard.style.display = 'block';
                rataRataNilai.textContent = nilai.rataRata;
                
                // Tampilkan detail nilai
                detailNilai.innerHTML = `
                    ${nilai.totalPoin} poin / ${nilai.totalHari} hari<br>
                    <span style="color: ${nilai.persentase >= 80 ? 'var(--success)' : nilai.persentase >= 60 ? 'var(--warning)' : 'var(--danger)'}">
                        ${nilai.persentase}% pencapaian
                    </span>
                `;
                
                // Warna berdasarkan nilai
                if (nilai.rataRata >= 8) {
                    rataRataNilai.style.color = 'var(--success)';
                } else if (nilai.rataRata >= 6) {
                    rataRataNilai.style.color = 'var(--warning)';
                } else {
                    rataRataNilai.style.color = 'var(--danger)';
                }
                
                console.log('📊 Detail Nilai:', {
                    siswa: studentName,
                    rataRata: nilai.rataRata,
                    totalPoin: nilai.totalPoin,
                    totalHari: nilai.totalHari,
                    persentase: nilai.persentase,
                    detail: nilai.detail
                });
                
            } else {
                // Sembunyikan jika tidak ada filter atau tidak ada data
                nilaiStatCard.style.display = 'none';
            }
        }

        // ✅ MODIFIKASI displayFilteredJournals UNTUK MENAMPILKAN NILAI
        function displayFilteredJournals(journals) {
            const journalsList = document.getElementById('journalsList');
            
            if (journals.length === 0) {
                journalsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3>Tidak ada jurnal yang sesuai dengan filter</h3>
                        <p>Coba ubah kriteria filter Anda</p>
                    </div>
                `;
                
                // ✅ SEMBUNYIKAN NILAI JIKA TIDAK ADA DATA
                document.getElementById('nilaiStatCard').style.display = 'none';
                return;
            }
            
            // ✅ TAMPILKAN NILAI JIKA FILTER SISWA DIPILIH
            if (selectedStudent !== 'all') {
                const studentName = journals[0]?.studentName || 'Siswa';
                tampilkanNilaiSiswa(journals, studentName);
            } else {
                document.getElementById('nilaiStatCard').style.display = 'none';
            }
            
            let journalsHTML = '';
            
            journals.forEach(journal => {
                // Kompatibel dengan createdAt (lama) dan timestamp (baru)
                const journalDate = journal.createdAt ? journal.createdAt.toDate() : 
                                  journal.timestamp ? journal.timestamp.toDate() : 
                                  new Date(journal.date);
                const completedActivities = Object.values(journal.activities).filter(val => val).length;
                const totalActivities = Object.keys(journal.activities).length;
                
                // ✅ HITUNG POIN UNTUK TAMPILAN
                let poinHarian = completedActivities;
                if (journal.doa && journal.doa.trim() !== '') {
                    poinHarian += 1;
                }
                const maksimalPoin = totalActivities + 1;
                const persentaseHarian = Math.round((poinHarian / maksimalPoin) * 100);
                
                journalsHTML += `
                    <div class="journal-card">
                        <div class="journal-header">
                            <div class="student-name">${journal.studentName}</div>
                            <div class="journal-date">
                                ${journalDate.toLocaleDateString('id-ID', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })}
                                <button onclick="editJournal('${journal.id}')" class="btn btn-sm" style="margin-left: 10px; padding: 5px 10px; background: var(--warning); color: var(--dark);">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                        </div>
                        
                        <!-- ✅ INFO POIN HARIAN -->
                        <div style="background: rgba(67, 97, 238, 0.1); padding: 10px 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600; color: var(--primary);">
                                    <i class="fas fa-star"></i> Poin Harian
                                </span>
                                <span style="font-weight: 700; color: ${persentaseHarian >= 80 ? 'var(--success)' : persentaseHarian >= 60 ? 'var(--warning)' : 'var(--danger)'};">
                                    ${poinHarian}/${maksimalPoin} poin (${persentaseHarian}%)
                                </span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; font-size: 0.8rem;">
                                <span>✅ Ceklis: ${completedActivities}/${totalActivities}</span>
                                <span>📝 Doa: ${journal.doa && journal.doa.trim() !== '' ? '1' : '0'}/1</span>
                            </div>
                        </div>
                        
                        <div class="activities-summary">
                            ${activities.map(activity => {
                                if (journal.activities[activity.id]) {
                                    return `<span class="activity-badge activity-completed">
                                        <i class="${activity.icon}"></i> ${activity.title}
                                    </span>`;
                                } else {
                                    return `<span class="activity-badge activity-missed">
                                        <i class="fas fa-times"></i> ${activity.title}
                                    </span>`;
                                }
                            }).join('')}
                        </div>
                        
                        ${journal.doa ? `
                            <div style="margin-top: 15px; padding: 15px; background: rgba(67, 97, 238, 0.05); border-radius: 10px;">
                                <strong><i class="fas fa-praying-hands"></i> Doa:</strong> ${journal.doa}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            journalsList.innerHTML = journalsHTML;
        }

        // ✅ MODIFIKASI applyFilters UNTUK MEMASTIKAN NILAI DITAMPILKAN
        window.applyFilters = function() {
            selectedActivity = document.getElementById('activityFilter').value;
            selectedDate = document.getElementById('dateFilter').value;
            
            let filteredJournals = allJournals;
            
            // Filter by student
            if (selectedStudent !== 'all') {
                filteredJournals = filteredJournals.filter(journal => 
                    journal.studentName === selectedStudent
                );
            }
            
            // Filter by activity
            if (selectedActivity !== 'all') {
                filteredJournals = filteredJournals.filter(journal => 
                    journal.activities[selectedActivity] === true
                );
            }
            
            // Filter by date
            if (selectedDate) {
                filteredJournals = filteredJournals.filter(journal => 
                    journal.date === selectedDate
                );
            }
            
            displayFilteredJournals(filteredJournals);
        }

        // ✅ MODIFIKASI clearFilters UNTUK MENYEMBUNYIKAN NILAI
        window.clearFilters = function() {
            document.getElementById('studentFilter').value = 'all';
            document.getElementById('activityFilter').value = 'all';
            document.getElementById('dateFilter').value = '';
            document.getElementById('missingDateFilter').value = '';
            
            selectedStudent = 'all';
            selectedActivity = 'all';
            selectedDate = '';
            
            document.getElementById('missingJournalsSection').classList.add('hidden');
            // ✅ SEMBUNYIKAN NILAI SAAT CLEAR FILTER
            document.getElementById('nilaiStatCard').style.display = 'none';
            applyFilters();
        }

        // ✅ MODIFIKASI filterByStudent UNTUK MEMASTIKAN NILAI DITAMPILKAN
        window.filterByStudent = function() {
            selectedStudent = document.getElementById('studentFilter').value;
            applyFilters();
        }

        // [FUNGSI LAINNYA TETAP SAMA...]
    </script>
</body>
</html>
